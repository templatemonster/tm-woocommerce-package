!function(n){"use strict";window.tmBannerGridWidgetAdmin={init:function(i,e){function t(){v=o.find(".tm_banners_grid_widget_img_col"),c=v.find(".banner_remove"),m=v.find(".banner_link"),c.on("click",function(){var i=n(this).closest(".tm_banners_grid_widget_img_col").index(),e=h.val().split(/(?=\S),(?=\S)/),t=b.val()?b.val().split(/(?=\S),(?=\S)/):[],l=f.val()?f.val().split(/(?=\S),(?=\S)/):[],a=w.val()?w.val().split(/(?=\S),(?=\S)/):[],d=u.val()?u.val().split(/(?=\S),(?=\S)/):[];e.splice(i,1),t.splice(i,1),l.splice(i,1),a.splice(i,1),d.splice(i,1),h.val(e.join()),b.val(t.join()),f.val(l.join()),w.val(a.join()),u.val(d.join()),n(this).closest(".tm_banners_grid_widget_img_col").remove(),p.hide().find("input").removeAttr("checked"),0<e.length&&p.eq(e.length-1).show().find("input").eq(0).prop("checked",!0),e.length<bannerGridWidgetAdmin.maxBanners&&g.show(),h.trigger("change")}),m.on("click",function(){var i=n(this).closest(".tm_banners_grid_widget_img_col").index(),e=b.val()?b.val().split(/(?=\S),(?=\S)/):[],t=f.val()?f.val().split(/(?=\S),(?=\S)/):[],l=w.val()?w.val().split(/(?=\S),(?=\S)/):[],a=u.val()?u.val().split(/(?=\S),(?=\S)/):[];n(".tm_banners_grid_widget_banner_id").val(i),S.dialog("open"),k.val(e[i]&&"null"!==e[i]?e[i]:""),j.find("option").filter(function(){return void 0!==t[i]&&n(this).val()==t[i]}).prop("selected",!0),A.val(l[i]&&"null"!==l[i]?l[i]:""),x.val(a[i]&&"null"!==a[i]?a[i]:"")})}function l(n,i,e){return r=n.splice(i,1),_=n.slice(0,e),s=n.slice(e),(n=_.concat(r).concat(s)).join()}var a,d,r,_,s,g=e.find(".tm_banners_grid_widget_add_media"),o=e.find(".tm_banners_grid_widget_banners_thumbs").find(".tm_banners_grid_widget_banners_thumbs_inner"),v=o.find(".tm_banners_grid_widget_img_col"),c=v.find(".banner_remove"),m=v.find(".banner_link"),p=e.find(".tm_banners_grid_widget_banners_grids").find(".tm_banners_grid_widget_banners_grid"),h=e.find(".tm_banners_grid_widget_banners"),b=e.find(".tm_banners_grid_widget_banners_links"),f=e.find(".tm_banners_grid_widget_banners_links_targets"),w=e.find(".tm_banners_grid_widget_banners_titles"),u=e.find(".tm_banners_grid_widget_banners_texts"),S=e.find(".banner_link_wrapper"),k=e.find(".tm_banners_grid_widget_banner_link"),j=e.find(".tm_banners_grid_widget_banner_link_target"),A=e.find(".tm_banners_grid_widget_banner_title"),x=e.find(".tm_banners_grid_widget_banner_text");n.validator.methods.url=function(n,i){return this.optional(i)||/(\/?[\w-]+)(\/[\w-]+)*\/?|(#)|(((http|ftp|https):\/\/)?[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?)/gi.test(n)},v.length<bannerGridWidgetAdmin.maxBanners&&g.show(),0<v.length&&p.eq(v.length-1).show(),g.on("click",function(n){if(i)i.open();else{var i=wp.media.frames.downloadable_file=wp.media({title:bannerGridWidgetAdmin.mediaFrameTitle,multiple:!0});i.on("select",function(){for(var n,e=[],l=h.val()?h.val().split(/(?=\S),(?=\S)/):[],a=bannerGridWidgetAdmin.maxBanners-l.length,d=i.state().get("selection").toJSON().slice(0,a),r=0;r<d.length;r++)e[r]=d[r].id,o.append(bannerGridWidgetAdmin.col.replace(/%s/g,d[r].sizes.thumbnail.url));6==(n=l.concat(e)).length&&g.hide(),p.hide().find("input").removeAttr("checked"),p.eq(n.length-1).show().find("input").eq(0).prop("checked",!0),i.detach(),t(),h.val(n.join()).trigger("change")}),i.open()}}),S.wrapInner("<form/>").dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,buttons:{Add:function(){if(k.closest("form").validate({onsubmit:!1}).element(k)){var n=S.find(".tm_banners_grid_widget_banner_id").val(),i=b.val()?b.val().split(/(?=\S),(?=\S)/):[],e=f.val()?f.val().split(/(?=\S),(?=\S)/):[],t=w.val()?w.val().split(/(?=\S),(?=\S)/):[],l=u.val()?u.val().split(/(?=\S),(?=\S)/):[];i[n]=k.val()?k.val():"null",e[n]=j.val()?j.val():"null",t[n]=A.val()?A.val():"null",l[n]=x.val()?x.val():"null",b.val(i.join()),f.val(e.join()),w.val(t.join()),u.val(l.join()),b.trigger("change"),S.dialog("close")}},Cancel:function(){S.dialog("close")}}}),t(),o.sortable({distance:2,zIndex:100,disabled:!1,start:function(n,i){a=i.item.index()},update:function(n,i){var e=h.val().split(/(?=\S),(?=\S)/),t=b.val()?b.val().split(/(?=\S),(?=\S)/):[],r=f.val()?f.val().split(/(?=\S),(?=\S)/):[],_=w.val()?w.val().split(/(?=\S),(?=\S)/):[],s=u.val()?u.val().split(/(?=\S),(?=\S)/):[];d=i.item.index(),h.val(l(e,a,d)),0<t.length&&(t.length<e.length&&(t[e.length]=""),b.val(l(t,a,d))),0<r.length&&(r.length<e.length&&(r[e.length]=""),f.val(l(r,a,d))),0<_.length&&(_.length<e.length&&(_[e.length]=""),w.val(l(_,a,d))),0<s.length&&(s.length<e.length&&(s[e.length]=""),u.val(l(s,a,d))),h.trigger("change")}})}},n("#widgets-right").find("div.widget[id*=tm_banners_grid_widget]").each(function(){window.tmBannerGridWidgetAdmin.init("init",n(this))}),n(document).on("widget-updated widget-added",function(n,i){i.is("[id*=tm_banners_grid_widget]")&&window.tmBannerGridWidgetAdmin.init(n,i)})}(jQuery);