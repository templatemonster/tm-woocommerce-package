!function(n){"use strict";window.tmBannerGridWidgetAdmin={init:function(i,e){function t(){if(j.closest("form").validate({onsubmit:!1}).element(j)){var n=k.find(".tm_banners_grid_widget_banner_id").val(),i=f.val()?f.val().split(/(?=\S),(?=\S)/):[],e=w.val()?w.val().split(/(?=\S),(?=\S)/):[],t=S.val()?S.val().split(/(?=\S),(?=\S)/):[],a=u.val()?u.val().split(/(?=\S),(?=\S)/):[];i[n]=j.val(),e[n]=A.val(),t[n]=x.val(),a[n]=G.val(),f.val(i.join()),w.val(e.join()),S.val(t.join()),u.val(a.join()),f.trigger("change"),k.dialog("close")}}function a(){c=v.find(".tm_banners_grid_widget_img_col"),m=c.find(".banner_remove"),p=c.find(".banner_link"),m.on("click",function(){var i=n(this).closest(".tm_banners_grid_widget_img_col").index(),e=b.val().split(/(?=\S),(?=\S)/),t=f.val()?f.val().split(/(?=\S),(?=\S)/):[],a=w.val()?w.val().split(/(?=\S),(?=\S)/):[],l=S.val()?S.val().split(/(?=\S),(?=\S)/):[],d=u.val()?u.val().split(/(?=\S),(?=\S)/):[];e.splice(i,1),t.splice(i,1),a.splice(i,1),l.splice(i,1),d.splice(i,1),b.val(e.join()),f.val(t.join()),w.val(a.join()),S.val(l.join()),u.val(d.join()),n(this).closest(".tm_banners_grid_widget_img_col").remove(),h.hide().find("input").removeAttr("checked"),0<e.length&&h.eq(e.length-1).show().find("input").eq(0).prop("checked",!0),e.length<bannerGridWidgetAdmin.maxBanners&&o.show(),b.trigger("change")}),p.on("click",function(){var i=n(this).closest(".tm_banners_grid_widget_img_col").index(),e=f.val()?f.val().split(/(?=\S),(?=\S)/):[],t=w.val()?w.val().split(/(?=\S),(?=\S)/):[],a=S.val()?S.val().split(/(?=\S),(?=\S)/):[],l=u.val()?u.val().split(/(?=\S),(?=\S)/):[];n(".tm_banners_grid_widget_banner_id").val(i),k.dialog("open"),j.val(e[i]?e[i]:""),A.find("option").filter(function(){return void 0!==t[i]&&n(this).val()==t[i]}).prop("selected",!0),x.val(a[i]?a[i]:""),G.val(l[i]?l[i]:"")})}function l(n,i,e){return _=n.splice(i,1),s=n.slice(0,e),g=n.slice(e),(n=s.concat(_).concat(g)).join()}var d,r,_,s,g,o=e.find(".tm_banners_grid_widget_add_media"),v=e.find(".tm_banners_grid_widget_banners_thumbs").find(".tm_banners_grid_widget_banners_thumbs_inner"),c=v.find(".tm_banners_grid_widget_img_col"),m=c.find(".banner_remove"),p=c.find(".banner_link"),h=e.find(".tm_banners_grid_widget_banners_grids").find(".tm_banners_grid_widget_banners_grid"),b=e.find(".tm_banners_grid_widget_banners"),f=e.find(".tm_banners_grid_widget_banners_links"),w=e.find(".tm_banners_grid_widget_banners_links_targets"),S=e.find(".tm_banners_grid_widget_banners_titles"),u=e.find(".tm_banners_grid_widget_banners_texts"),k=e.find(".banner_link_wrapper"),j=e.find(".tm_banners_grid_widget_banner_link"),A=e.find(".tm_banners_grid_widget_banner_link_target"),x=e.find(".tm_banners_grid_widget_banner_title"),G=e.find(".tm_banners_grid_widget_banner_text");n.validator.methods.url=function(n,i){return this.optional(i)||/(\/?[\w-]+)(\/[\w-]+)*\/?|(#)|(((http|ftp|https):\/\/)?[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?)/gi.test(n)},c.length<bannerGridWidgetAdmin.maxBanners&&o.show(),0<c.length&&h.eq(c.length-1).show(),o.on("click",function(n){if(i)i.open();else{var i=wp.media.frames.downloadable_file=wp.media({title:bannerGridWidgetAdmin.mediaFrameTitle,multiple:!0});i.on("select",function(){for(var n,e=[],t=b.val()?b.val().split(/(?=\S),(?=\S)/):[],l=bannerGridWidgetAdmin.maxBanners-t.length,d=i.state().get("selection").toJSON().slice(0,l),r=0;r<d.length;r++)e[r]=d[r].id,v.append(bannerGridWidgetAdmin.col.replace(/%s/g,d[r].sizes.thumbnail.url));6==(n=t.concat(e)).length&&o.hide(),h.hide().find("input").removeAttr("checked"),h.eq(n.length-1).show().find("input").eq(0).prop("checked",!0),i.detach(),a(),b.val(n.join()).trigger("change")}),i.open()}}),k.wrapInner("<form/>").dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,buttons:{Add:t,Cancel:function(){k.dialog("close")}}}),a(),v.sortable({distance:2,zIndex:100,disabled:!1,start:function(n,i){d=i.item.index()},update:function(n,i){var e=b.val().split(/(?=\S),(?=\S)/),t=f.val()?f.val().split(/(?=\S),(?=\S)/):[],a=w.val()?w.val().split(/(?=\S),(?=\S)/):[],_=S.val()?S.val().split(/(?=\S),(?=\S)/):[],s=u.val()?u.val().split(/(?=\S),(?=\S)/):[];r=i.item.index(),b.val(l(e,d,r)),0<t.length&&(t.length<e.length&&(t[e.length]=""),f.val(l(t,d,r))),0<a.length&&(a.length<e.length&&(a[e.length]=""),w.val(l(a,d,r))),0<_.length&&(_.length<e.length&&(_[e.length]=""),S.val(l(_,d,r))),0<s.length&&(s.length<e.length&&(s[e.length]=""),u.val(l(s,d,r))),b.trigger("change")}})}},n("#widgets-right").find("div.widget[id*=tm_banners_grid_widget]").each(function(){window.tmBannerGridWidgetAdmin.init("init",n(this))}),n(document).on("widget-updated widget-added",function(n,i){i.is("[id*=tm_banners_grid_widget]")&&window.tmBannerGridWidgetAdmin.init(n,i)})}(jQuery);